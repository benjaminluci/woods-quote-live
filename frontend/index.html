<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Woods Quoting Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; }
    body { font-family: system-ui, Arial, sans-serif; background:#f6f7f9; display:flex; flex-direction:column; }
    header { padding:12px 16px; background:#111827; color:#fff; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header small { opacity:.8; font-size:.8rem; }
    #chat { flex:1; overflow:auto; padding:16px; }
    .msg { max-width: 720px; margin: 8px auto; padding: 12px 14px; border-radius: 12px; white-space: pre-wrap; line-height: 1.45; }
    .user { background:#2563eb; color:#fff; margin-left:auto; }
    .bot { background:#fff; border:1px solid #e5e7eb; margin-right:auto; }
    footer { display:flex; gap:8px; padding:12px; background:#fff; border-top:1px solid #e5e7eb; position:sticky; bottom:0; }
    input { flex:1; font-size:16px; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; outline:none; }
    button { padding:10px 14px; border:none; border-radius:10px; background:#111827; color:#fff; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <header>
    <div>Woods Quoting Assistant</div>
    <small id="env"></small>
  </header>

  <div id="chat" aria-live="polite"></div>

  <footer>
    <input id="inp" placeholder="Please Enter Dealer Number To Begin Quoting" autocomplete="off" />
    <button id="send">Send</button>
  </footer>

  <script>
    // ====== CONFIG ======
    // Prefer same-origin. If your backend lives elsewhere, set window.CHAT_BACKEND = "https://your-domain/chat" before this script.
    const CHAT_BACKEND  = (window.CHAT_BACKEND || '/chat');
    const HEALTH_BACKEND = CHAT_BACKEND.replace(/\/chat$/, '/health');

    // ====== SESSION (PERSISTENT) ======
    function getSessionId() {
      const KEY = 'woods_sid';
      let sid = localStorage.getItem(KEY);
      if (!sid) {
        sid = 'sid-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem(KEY, sid);
      }
      return sid;
    }
    const SESSION_ID = getSessionId();

    // ====== UI helpers ======
    const chat = document.getElementById('chat');
    const inp  = document.getElementById('inp');
    const btn  = document.getElementById('send');
    const env  = document.getElementById('env');

    function addMsg(text, who='bot') {
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function setBusy(b) {
      btn.disabled = b;
      inp.disabled = b;
    }

    // show small env hint (backend host + short SID)
    try {
      const a = document.createElement('a');
      a.href = CHAT_BACKEND;
      const shortSid = SESSION_ID.slice(0, 8);
      env.textContent = `${a.origin || location.origin} · sid:${shortSid}`;
    } catch {
      env.textContent = `sid:${SESSION_ID.slice(0,8)}`;
    }

    // Optional: warm-up /health (non-blocking)
    (async () => {
      try {
        const r = await fetch(HEALTH_BACKEND, { method: 'GET' });
        // You could parse and show a ✔️/⚠️ here if you want
      } catch {}
    })();

    // ====== SEND logic ======
    async function send() {
      const text = inp.value.trim();
      if (!text) return;

      addMsg(text, 'user');
      inp.value = '';
      setBusy(true);

      try {
        const res = await fetch(CHAT_BACKEND, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // >>> IMPORTANT: send the session ID in BOTH header and body <<<
            'X-Session-Id': SESSION_ID
          },
          body: JSON.stringify({
            session_id: SESSION_ID,
            message: text
          })
        });

        const data = await res.json().catch(() => ({}));
        const reply = (data && (data.reply || data.error)) || 'Sorry, no response.';
        addMsg(reply, 'bot');

        // If your backend returns a dealer badge, you can show it here:
        // if (data && data.dealer && (data.dealer.dealer_number || data.dealer.dealer_name)) {
        //   env.textContent = `${env.textContent.split(' · ')[0]} · ${data.dealer.dealer_name || ''} #${data.dealer.dealer_number || ''}`.trim();
        // }

      } catch (e) {
        addMsg('Network error. Please try again in a moment.', 'bot');
      } finally {
        setBusy(false);
        inp.focus();
      }
    }

    btn.addEventListener('click', send);
    inp.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

    // Focus input on load
    window.addEventListener('load', () => inp.focus(), { once: true });
  </script>
</body>
</html>
