<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Woods Quoting Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; }
    body { font-family: system-ui, Arial, sans-serif; background:#f6f7f9; display:flex; flex-direction:column; }
    header { padding:12px 16px; background:#111827; color:#fff; display:flex; align-items:center; gap:12px; }
    header small { opacity:.8; font-size:.8rem; }
    #chat { flex:1; overflow:auto; padding:16px; }
    .msg { max-width: 720px; margin: 8px auto; padding: 12px 14px; border-radius: 12px; white-space: pre-wrap; line-height: 1.45; }
    .user { background:#2563eb; color:#fff; margin-left:auto; }
    .bot { background:#fff; border:1px solid #e5e7eb; margin-right:auto; }
    footer { display:flex; gap:8px; padding:12px; background:#fff; border-top:1px solid #e5e7eb; position:sticky; bottom:0; }
    input { flex:1; padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; outline:none; }
    input:focus { border-color:#111827; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #111827; background:#111827; color:#fff; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:flex; align-items:center; gap:10px; }
    .pill { background:#fff; color:#111827; border:1px solid #e5e7eb; padding:4px 8px; border-radius:999px; font-size:.75rem; }
  </style>
</head>
<body>
  <header>
    <div>Woods Quoting Assistant</div>
    <small id="env"></small>
  </header>
  <div id="chat" aria-live="polite"></div>
  <footer>
    <input id="inp" placeholder="Please Enter Dealer Number To Begin Quoting" autocomplete="off" />
    <button id="send">Send</button>
  </footer>

  <script>
    // ====== CONFIG ======
    // Your AI bot endpoint (NOT the Woods Pricing API). This is the server that proxies tools to your app.py API.
    const CHAT_BACKEND = 'https://woods-quote-backend.onrender.com/chat';
    const HEALTH_BACKEND = CHAT_BACKEND.replace(/\/chat$/, '/health');

    // ====== ELEMENTS ======
    const chat = document.getElementById('chat');
    const inp  = document.getElementById('inp');
    const btn  = document.getElementById('send');
    const env  = document.getElementById('env');

    // ====== SESSION (sticky across page loads) ======
    const SID_KEY = 'woods_sid';
    let sessionId = localStorage.getItem(SID_KEY);
    if (!sessionId) {
      sessionId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
      localStorage.setItem(SID_KEY, sessionId);
    }

    // Show quick env info in header for troubleshooting
    env.textContent = `session: ${sessionId.slice(0,8)}… · backend: ${new URL(CHAT_BACKEND).host}`;

    // ====== UI helpers ======
    function add(text, who) {
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function setBusy(state) {
      btn.disabled = state;
      inp.disabled = state;
    }

    // ====== Warm-up (pre-ping backend so upstream Render isn't sleepy) ======
    async function warmUp() {
      try { await fetch(HEALTH_BACKEND, { method: 'GET', cache: 'no-store' }); }
      catch (_) { /* ignore */ }
    }
    // fire and forget
    warmUp();

    // ====== Send message ======
    async function send() {
      const text = inp.value.trim();
      if (!text) return;
      inp.value = '';
      add(text, 'user');
      add('…', 'bot');
      const thinking = chat.lastChild;
      setBusy(true);

      try {
        const r = await fetch(CHAT_BACKEND, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-Id': sessionId  // CRITICAL: same session every turn
          },
          body: JSON.stringify({ message: text })
        });
        const data = await r.json();
        thinking.remove();
        add((data && data.reply) ? data.reply : JSON.stringify(data, null, 2), 'bot');

        // If we hit a connector error on the first real quote, try warming again silently.
        if (typeof data?.reply === 'string' && data.reply.includes('system error while retrieving data')) {
          warmUp();
        }
      } catch (e) {
        thinking.remove();
        add('Error: ' + (e?.message || e), 'bot');
      } finally {
        setBusy(false);
        inp.focus();
      }
    }

    btn.addEventListener('click', send);
    inp.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

    // Focus input on load
    window.addEventListener('load', () => inp.focus(), { once: true });
  </script>
</body>
</html>

